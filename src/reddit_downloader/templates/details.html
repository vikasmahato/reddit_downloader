{% extends "base.html" %}

{% block title %}Image Details - Reddit Image Browser{% endblock %}

{% block content %}
<style>
.deleted-image {
    background-color: #2c2c2c !important;
}
.card,
.card-header,
.card-footer {
    background: rgba(35, 37, 38, 0.8) !important;
    backdrop-filter: blur(10px);
    color: #e0e0e0 !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}
.card-body {
    background: rgba(35, 37, 38, 0.6) !important;
    color: #e0e0e0 !important;
}
.table {
    background: rgba(35, 37, 38, 0.6) !important;
    color: #e0e0e0 !important;
    border-radius: 8px;
}
.table th,
.table td {
    border-color: rgba(255,255,255,0.1) !important;
}
.btn-primary, .btn-outline-primary {
    background: linear-gradient(135deg, #ff4500 0%, #ff6b35 100%) !important;
    color: #fff !important;
    border: none !important;
    border-radius: 8px;
    font-weight: 600;
}
.btn-primary:hover, .btn-outline-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(255, 69, 0, 0.4);
}
.btn-outline-secondary, .btn-secondary {
    background: rgba(35, 37, 38, 0.8) !important;
    color: #e0e0e0 !important;
    border: 1px solid rgba(255,255,255,0.15) !important;
    border-radius: 8px;
}
.btn-outline-secondary:hover, .btn-secondary:hover {
    background: rgba(255,255,255,0.1) !important;
    transform: translateY(-1px);
}
.btn-outline-info, .btn-info {
    background: rgba(35, 37, 38, 0.8) !important;
    color: #e0e0e0 !important;
    border: 1px solid rgba(255,255,255,0.15) !important;
    border-radius: 8px;
}
.btn-outline-info:hover, .btn-info:hover {
    background: rgba(255,255,255,0.1) !important;
    transform: translateY(-1px);
}
.btn-outline-danger, .btn-danger {
    background: rgba(35, 37, 38, 0.8) !important;
    color: #e0e0e0 !important;
    border: 1px solid rgba(255,255,255,0.15) !important;
    border-radius: 8px;
}
.btn-outline-danger:hover, .btn-danger:hover {
    background: rgba(231, 76, 60, 0.3) !important;
    transform: translateY(-1px);
}
.badge {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
}
.list-group-item {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
.alert {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
pre code {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
}
.carousel-control-prev, .carousel-control-next {
    width: 50px;
    height: 50px;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
}
.carousel-control-prev {
    left: 10px;
}
.carousel-control-next {
    right: 10px;
}
.carousel-indicators {
    margin-bottom: 1rem;
}
.carousel-indicators button {
    background-color: rgba(255, 255, 255, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.8);
}
.carousel-indicators button.active {
    background-color: #ff4500;
    border-color: #ff4500;
}
</style>
<div class="row">
    <div class="col-md-8">
        <div class="card{% if image.is_deleted %} deleted-image{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-info-circle"></i> Image Details</h4>
                <div>
                    {% if image.post_images and image.post_images|length > 1 %}
                        {% set current_index = image.current_image_index if image.current_image_index is defined else 0 %}
                        <span class="badge bg-secondary me-2">{{ current_index + 1 }} / {{ image.post_images|length }}</span>
                    {% endif %}
                    {% if image.id > 1 %}
                    <a href="/details/{{ image.id - 1 }}" class="btn btn-outline-secondary btn-sm me-1" title="Previous Image">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    {% endif %}
                    <a href="/details/{{ image.id + 1 }}" class="btn btn-outline-secondary btn-sm" title="Next Image">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <h5>{{ image.title or 'Untitled' }}</h5>
                <div class="mb-2">
                    <span class="badge bg-primary">r/{{ image.subreddit or 'Unknown' }}</span>
                    <span class="badge bg-info text-dark">u/{{ image.author or 'Unknown' }}</span>
                </div>
                {# Use only the local served file on the details page; do NOT use remote URLs or fallbacks #}
                <div class="text-center mb-4">
                    {% set post_images = image.post_images if image.post_images else [image] %}
                    {% set image_count = image.image_count if image.image_count else 1 %}
                    {% set current_index = image.current_image_index if image.current_image_index is defined else 0 %}
                    
                    {% if image_count > 1 %}
                        {# Carousel for multiple images #}
                        <div id="carousel-details" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                            <div class="carousel-inner">
                                {% for post_img in post_images %}
                                <div class="carousel-item {% if loop.index0 == current_index %}active{% endif %}">
                                    {% if post_img.web_path %}
                                        {% set ext = post_img.filename.split('.')[-1].lower() if post_img.filename else 'jpg' %}
                                        {% if ext == 'mp4' %}
                                            <video controls class="img-fluid rounded shadow mx-auto" style="max-width:100%;height:auto;max-height:600px;">
                                                <source src="{{ url_for('static', filename=post_img.web_path) }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                        {% else %}
                                            <img src="{{ url_for('static', filename=post_img.web_path) }}" class="img-fluid rounded shadow mx-auto" style="max-width:100%;height:auto;max-height:600px;" alt="{{ image.title or 'Reddit Image' }}">
                                        {% endif %}
                                    {% else %}
                                        <div class="alert alert-warning">Image not found.</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-details" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carousel-details" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            <div class="carousel-indicators">
                                {% for post_img in post_images %}
                                <button type="button" data-bs-target="#carousel-details" data-bs-slide-to="{{ loop.index0 }}" {% if loop.index0 == current_index %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ loop.index }}"></button>
                                {% endfor %}
                            </div>
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-dark opacity-75">{{ current_index + 1 }} / {{ image_count }}</span>
                            </div>
                        </div>
                    {% else %}
                        {# Single image #}
                        {% if image.web_path %}
                            {% set ext = image.filename.split('.')[-1].lower() %}
                            {% if ext == 'mp4' %}
                                <video controls class="img-fluid rounded shadow mx-auto" style="max-width:100%;height:auto;max-height:600px;">
                                    <source src="{{ url_for('static', filename=image.web_path) }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% else %}
                                <img src="{{ url_for('static', filename=image.web_path) }}" class="img-fluid rounded shadow mx-auto" style="max-width:100%;height:auto;max-height:600px;" alt="{{ image.title or 'Reddit Image' }}">
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning">Image not found.</div>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Collapsible Metadata Panel -->
                <div class="accordion mb-4" id="metaAccordion">
                    <div class="accordion-item bg-dark text-light">
                        <h2 class="accordion-header" id="metaHeading">
                            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#metaCollapse" aria-expanded="false" aria-controls="metaCollapse">
                                Metadata & File Info
                            </button>
                        </h2>
                        <div id="metaCollapse" class="accordion-collapse collapse" aria-labelledby="metaHeading" data-bs-parent="#metaAccordion">
                            <div class="accordion-body">
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-subreddit"></i> Reddit Information</h6>
                                        <table class="table table-borderless table-sm">
                                            <tr>
                                                <td><strong>Subreddit:</strong></td>
                                                <td><a href="/?subreddit={{ image.subreddit }}" class="text-decoration-none">
                                                    r/{{ image.subreddit or 'Unknown' }}
                                                </a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Author:</strong></td>
                                                {% if image.author %}
                                                <td><a href="/?user={{ image.author }}" class="text-decoration-none">
                                                    u/{{ image.author }}
                                                </a></td>
                                                {% else %}
                                                <td>Unknown</td>
                                                {% endif %}
                                            </tr>
                                            <tr>
                                                <td><strong>Posted:</strong></td>
                                                <td>{{ image.download_date }} {{ image.download_time }}</td>
                                            </tr>
                                            {% if image.permalink %}
                                            <tr>
                                                <td><strong>Reddit Link:</strong></td>
                                                <td><a href="https://reddit.com{{ image.permalink }}" target="_blank"
                                                       class="btn btn-sm btn-outline-primary">
                                                    <i class="fab fa-reddit"></i> View on Reddit
                                                </a></td>
                                            </tr>
                                            {% endif %}
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-file"></i> File Information</h6>
                                        <table class="table table-borderless table-sm">
                                            <tr>
                                                <td><strong>Filename:</strong></td>
                                                <td><code>{{ image.filename or 'Unknown' }}</code></td>
                                            </tr>
                                            {% if image.file_size %}
                                            <tr>
                                                <td><strong>Size:</strong></td>
                                                <td>{{ "%.1f"|format(image.file_size/1024) }} KB ({{ "%.1f"|format(image.file_size/1024/1024) }} MB)</td>
                                            </tr>
                                            {% endif %}
                                            {% if image.file_hash %}
                                            <tr>
                                                <td><strong>MD5 Hash:</strong></td>
                                                <td><code style="font-size: 0.8rem;">{{ image.file_hash }}</code></td>
                                            </tr>
                                            {% endif %}
                                            <tr>
                                                <td><strong>Downloaded:</strong></td>
                                                <td>{{ image.download_date }} at {{ image.download_time }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>File Path:</strong></td>
                                                <td><code style="font-size: 0.8rem;">{{ image.file_path }}</code></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <div>
                        {% set post_images = image.post_images if image.post_images else [image] %}
                        {% set current_index = image.current_image_index if image.current_image_index is defined else 0 %}
                        {% set current_img = post_images[current_index] if post_images else image %}
                        
                        {% if current_img.web_path %}
                        <a href="{{ url_for('static', filename=current_img.web_path) }}" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i> View Full Size
                        </a>
                        <a href="{{ url_for('static', filename=current_img.web_path) }}" download="{{ current_img.filename or image.filename }}" class="btn btn-outline-primary">
                            <i class="fas fa-download"></i> Download
                        </a>
                        {% endif %}
                        {% if image.post_id %}
                        <button type="button" class="btn btn-outline-danger" onclick="deletePost({{ image.post_id }}, {{ image.id }})">
                            <i class="fas fa-trash"></i> Delete Post
                        </button>
                        {% endif %}
                    </div>
                    <div>
                        {% if image.post_images and image.post_images|length > 1 %}
                            {% set current_index = image.current_image_index if image.current_image_index is defined else 0 %}
                            {% if current_index > 0 %}
                                {% set prev_img = image.post_images[current_index - 1] %}
                                <a href="/details/{{ prev_img.id }}" class="btn btn-outline-secondary me-1">
                                    <i class="fas fa-arrow-left"></i> Previous
                                </a>
                            {% endif %}
                            {% if current_index < image.post_images|length - 1 %}
                                {% set next_img = image.post_images[current_index + 1] %}
                                <a href="/details/{{ next_img.id }}" class="btn btn-outline-secondary me-1">
                                    Next <i class="fas fa-arrow-right"></i>
                                </a>
                            {% endif %}
                        {% endif %}
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Gallery
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">

         {% if image.comments %}
    <!-- Comment Input Box -->
    <div class="card mb-3">
        <div class="card-header">
            <h6><i class="fas fa-plus"></i> Add a Comment</h6>
        </div>
        <div class="card-body">
            <form id="commentForm">
                <div class="mb-2">
                    <textarea class="form-control" id="commentText" name="comment" rows="2" placeholder="Write your comment..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
                <div id="commentStatus" class="mt-2" style="display:none;"></div>
            </form>
        </div>
    </div>
    <!-- End Comment Input Box -->

    <div class="card">
        <div class="card-header">
            <h6><i class="fas fa-comments"></i> Top Comments</h6>
        </div>
        <div class="card-body">
            {% set comments = image.comments | safe | loads %}
            {% if comments and comments|length > 0 %}
            <ul class="list-group" id="commentsList">
                {% for comment in comments %}
                <li class="list-group-item">
                    <div class="fw-bold" style="font-size:0.80em;">{{ comment.author or 'Unknown' }}</div>
                    <div class="text-muted" style="font-size:0.50em;">Score: {{ comment.score }} | {{ comment.created_utc | format_datetime }}</div>
                    <div style="font-size:0.80em;">{{ comment.body }}</div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="text-muted">No comments found.</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-bar"></i> Quick Stats</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Database ID:</span>
                        <code>{{ image.id }}</code>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Status:</span>
                        <span class="badge bg-{% if image.is_deleted %}danger{% else %}success{% endif %}">
                            {% if image.is_deleted %}Deleted{% else %}Active{% endif %}
                        </span>
                    </div>
                    {% if image.file_hash %}
                    <div class="list-group-item">
                        <small class="text-muted">File Integrity Verified</small><br>
                        <code style="font-size: 0.7rem;">{{ image.file_hash }}</code>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-link"></i> Quick Links</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if image.subreddit %}
                    <a href="/?subreddit={{ image.subreddit }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-filter"></i> More from r/{{ image.subreddit }}
                    </a>
                    {% endif %}
                    {% if image.author %}
                    <a href="/?user={{ image.author }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-user"></i> More from u/{{ image.author }}
                    </a>
                    {% endif %}
                    {% if image.permalink %}
                    <a href="https://reddit.com{{ image.permalink }}" target="_blank" class="btn btn-outline-danger btn-sm">
                        <i class="fab fa-reddit"></i> Original Reddit Post
                    </a>
                    {% endif %}
                    <a href="/" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-home"></i> Gallery Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Raw JSON Data (for debugging) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-code"></i> Raw Metadata</h6>
            </div>
            <div class="card-body">
                <pre><code>{{ image | tojson(indent=2) }}</code></pre>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-copy filename on click
document.querySelectorAll('code').forEach(code => {
    code.addEventListener('click', function() {
        const text = this.textContent;
        navigator.clipboard.writeText(text).then(() => {
            // Show a small toast notification
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.innerHTML = '<div class="toast show" role="alert"><div class="toast-body">Copied to clipboard!</div></div>';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        });
    });
    
    code.style.cursor = 'pointer';
    code.title = 'Click to copy';
});

// AJAX for comment submission
document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var commentText = document.getElementById('commentText').value.trim();
    var statusDiv = document.getElementById('commentStatus');
    if (!commentText) {
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-warning';
        statusDiv.textContent = 'Comment cannot be empty.';
        return;
    }
    statusDiv.style.display = 'none';
    fetch('/api/post_comment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            image_id: '{{ image.id }}',
            comment: commentText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new comment to the top of the list
            var commentsList = document.getElementById('commentsList');
            var newComment = document.createElement('li');
            newComment.className = 'list-group-item';
            newComment.innerHTML = `<div class='fw-bold' style='font-size:0.80em;'>${data.comment.author || 'You'}</div>
                <div class='text-muted' style='font-size:0.50em;'>Score: ${data.comment.score || 1} | just now</div>
                <div style='font-size:0.80em;'>${data.comment.body}</div>`;
            if (commentsList) {
                commentsList.prepend(newComment);
            }
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-success';
            statusDiv.textContent = 'Comment posted successfully!';
            document.getElementById('commentText').value = '';
        } else {
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = data.error || 'Failed to post comment.';
        }
    })
    .catch(() => {
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-danger';
        statusDiv.textContent = 'Network error.';
    });
});

// Update URL when carousel changes on details page
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('carousel-details');
    if (carousel) {
        const postImages = {{ image.post_images | tojson if image.post_images else '[]' }};
        carousel.addEventListener('slid.bs.carousel', function(event) {
            const activeIndex = event.to;
            if (postImages && postImages[activeIndex]) {
                const newImageId = postImages[activeIndex].id;
                // Update URL without page reload
                window.history.replaceState({}, '', '/details/' + newImageId);
            }
        });
    }
});

// Auto-fetch and update comments on page load
window.addEventListener('DOMContentLoaded', function() {
    var imageId = {{ image.id }};
    var commentsList = document.getElementById('commentsList');
    var commentsCardBody = commentsList ? commentsList.parentElement : null;
    fetch('/api/comments/' + imageId)
        .then(response => response.json())
        .then(data => {
            if (data.success && commentsList && commentsCardBody) {
                if (data.comments.length > 0) {
                    commentsList.innerHTML = '';
                    data.comments.forEach(function(comment) {
                        var li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `<div class='fw-bold' style='font-size:0.80em;'>${comment.author || 'Unknown'}</div>
                            <div class='text-muted' style='font-size:0.50em;'>Score: ${comment.score || 1} | ${comment.created_utc ? new Date(comment.created_utc * 1000).toLocaleString() : ''}</div>
                            <div style='font-size:0.80em;'>${comment.body}</div>`;
                        commentsList.appendChild(li);
                    });
                } else {
                    commentsList.innerHTML = '';
                    var noCommentsDiv = document.createElement('div');
                    noCommentsDiv.className = 'text-muted';
                    noCommentsDiv.textContent = 'No comments found.';
                    commentsCardBody.appendChild(noCommentsDiv);
                }
            }
        });
});

// Delete post function
function deletePost(postId, imageId) {
    if (!confirm('Are you sure you want to delete this post? This will:\n- Delete the post from the database\n- If the image is not linked to other posts, it will be deleted and moved to /deleted folder\n\nThis action cannot be undone!')) {
        return;
    }
    
    fetch(`/api/delete-post/${postId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ image_id: imageId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Post deleted successfully!');
            window.location.href = '/';
        } else {
            alert('Error: ' + (data.error || 'Failed to delete post'));
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}
</script>

{% endblock %}
{% extends "base.html" %}

{% block title %}Image Details - Reddit Image Browser{% endblock %}

{% block content %}
<style>
.deleted-image {
    background-color: #2c2c2c !important;
}
.card,
.card-header,
.card-footer {
    background-color: #181a1b !important;
    color: #e0e0e0 !important;
    border-color: #222 !important;
}
.card-body {
    background-color: #181a1b !important;
    color: #e0e0e0 !important;
}
.table {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
}
.table th,
.table td {
    border-color: #444 !important;
}
.btn-primary, .btn-outline-primary {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
.btn-primary:hover, .btn-outline-primary:hover {
    background-color: #444 !important;
    color: #fff !important;
    border-color: #0984e3 !important;
}
.btn-outline-secondary, .btn-secondary {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
.btn-outline-secondary:hover, .btn-secondary:hover {
    background-color: #444 !important;
    color: #fff !important;
    border-color: #0984e3 !important;
}
.btn-outline-info, .btn-info {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
.btn-outline-info:hover, .btn-info:hover {
    background-color: #444 !important;
    color: #fff !important;
    border-color: #0984e3 !important;
}
.btn-outline-danger, .btn-danger {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
.btn-outline-danger:hover, .btn-danger:hover {
    background-color: #444 !important;
    color: #fff !important;
    border-color: #e74c3c !important;
}
.badge {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
}
.list-group-item {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
.alert {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
pre code {
    background-color: #232526 !important;
    color: #e0e0e0 !important;
}
</style>
<div class="row">
    <div class="col-md-8">
        <div class="card{% if image.is_deleted %} deleted-image{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-info-circle"></i> Image Details</h4>
                <div>
                    {% if image.id > 1 %}
                    <a href="/details/{{ image.id - 1 }}" class="btn btn-outline-secondary btn-sm me-1" title="Previous">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    {% endif %}
                    <a href="/details/{{ image.id + 1 }}" class="btn btn-outline-secondary btn-sm" title="Next">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <h5>{{ image.title or 'Untitled' }}</h5>
                <div class="mb-2">
                    <span class="badge bg-primary">r/{{ image.subreddit or 'Unknown' }}</span>
                    <span class="badge bg-info text-dark">u/{{ image.author or 'Unknown' }}</span>
                </div>
                {% set image_urls = image.url.split(',') if image.url else [] %}
                <div class="text-center mb-4">
                    {% if image_urls and image_urls[0].strip() %}
                        {% if image_urls|length > 1 %}
                        <!-- Bootstrap Carousel for gallery -->
                        <div id="galleryCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for img_url in image_urls %}
                                <div class="carousel-item {% if loop.index0 == 0 %}active{% endif %}">
                                    <img src="/reddit_downloads/{{ image.web_path }}" class="d-block rounded shadow mx-auto" style="max-width: 100%; height: auto; max-height: 600px;" alt="Gallery Image">
                                </div>
                                {% endfor %}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                        {% else %}
                        <img src="{{ image_urls[0].strip() }}" class="img-fluid rounded shadow mx-auto" style="max-width: 100%; height: auto; max-height: 600px;" alt="{{ image.title or 'Reddit Image' }}">
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">Image not found.</div>
                    {% endif %}
                </div>

                <!-- Collapsible Metadata Panel -->
                <div class="accordion mb-4" id="metaAccordion">
                    <div class="accordion-item bg-dark text-light">
                        <h2 class="accordion-header" id="metaHeading">
                            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#metaCollapse" aria-expanded="false" aria-controls="metaCollapse">
                                Metadata & File Info
                            </button>
                        </h2>
                        <div id="metaCollapse" class="accordion-collapse collapse" aria-labelledby="metaHeading" data-bs-parent="#metaAccordion">
                            <div class="accordion-body">
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-subreddit"></i> Reddit Information</h6>
                                        <table class="table table-borderless table-sm">
                                            <tr>
                                                <td><strong>Subreddit:</strong></td>
                                                <td><a href="/?subreddit={{ image.subreddit }}" class="text-decoration-none">
                                                    r/{{ image.subreddit or 'Unknown' }}
                                                </a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Author:</strong></td>
                                                {% if image.author %}
                                                <td><a href="/?user={{ image.author }}" class="text-decoration-none">
                                                    u/{{ image.author }}
                                                </a></td>
                                                {% else %}
                                                <td>Unknown</td>
                                                {% endif %}
                                            </tr>
                                            <tr>
                                                <td><strong>Posted:</strong></td>
                                                <td>{{ image.download_date }} {{ image.download_time }}</td>
                                            </tr>
                                            {% if image.permalink %}
                                            <tr>
                                                <td><strong>Reddit Link:</strong></td>
                                                <td><a href="https://reddit.com{{ image.permalink }}" target="_blank"
                                                       class="btn btn-sm btn-outline-primary">
                                                    <i class="fab fa-reddit"></i> View on Reddit
                                                </a></td>
                                            </tr>
                                            {% endif %}
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-file"></i> File Information</h6>
                                        <table class="table table-borderless table-sm">
                                            <tr>
                                                <td><strong>Filename:</strong></td>
                                                <td><code>{{ image.filename or 'Unknown' }}</code></td>
                                            </tr>
                                            {% if image.file_size %}
                                            <tr>
                                                <td><strong>Size:</strong></td>
                                                <td>{{ "%.1f"|format(image.file_size/1024) }} KB ({{ "%.1f"|format(image.file_size/1024/1024) }} MB)</td>
                                            </tr>
                                            {% endif %}
                                            {% if image.file_hash %}
                                            <tr>
                                                <td><strong>MD5 Hash:</strong></td>
                                                <td><code style="font-size: 0.8rem;">{{ image.file_hash }}</code></td>
                                            </tr>
                                            {% endif %}
                                            <tr>
                                                <td><strong>Downloaded:</strong></td>
                                                <td>{{ image.download_date }} at {{ image.download_time }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>File Path:</strong></td>
                                                <td><code style="font-size: 0.8rem;">{{ image.file_path }}</code></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <div>
                        {% if image.web_path %}
                        <a href="/image/{{ image.web_path }}" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i> View Full Size
                        </a>
                        <a href="/image/{{ image.web_path }}" download="{{ image.filename }}" class="btn btn-outline-primary">
                            <i class="fas fa-download"></i> Download
                        </a>
                        {% endif %}
                    </div>
                    <div>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Gallery
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">

         {% if image.comments %}
    <!-- Comment Input Box -->
    <div class="card mb-3">
        <div class="card-header">
            <h6><i class="fas fa-plus"></i> Add a Comment</h6>
        </div>
        <div class="card-body">
            <form id="commentForm">
                <div class="mb-2">
                    <textarea class="form-control" id="commentText" name="comment" rows="2" placeholder="Write your comment..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
                <div id="commentStatus" class="mt-2" style="display:none;"></div>
            </form>
        </div>
    </div>
    <!-- End Comment Input Box -->

    <div class="card">
        <div class="card-header">
            <h6><i class="fas fa-comments"></i> Top Comments</h6>
        </div>
        <div class="card-body">
            {% set comments = image.comments | safe | loads %}
            {% if comments and comments|length > 0 %}
            <ul class="list-group" id="commentsList">
                {% for comment in comments %}
                <li class="list-group-item">
                    <div class="fw-bold" style="font-size:0.80em;">{{ comment.author or 'Unknown' }}</div>
                    <div class="text-muted" style="font-size:0.50em;">Score: {{ comment.score }} | {{ comment.created_utc | format_datetime }}</div>
                    <div style="font-size:0.80em;">{{ comment.body }}</div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="text-muted">No comments found.</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-bar"></i> Quick Stats</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Database ID:</span>
                        <code>{{ image.id }}</code>
                    </div>
                    <div class="list-group-item d-flex justify-content-between">
                        <span>Status:</span>
                        <span class="badge bg-{% if image.is_deleted %}danger{% else %}success{% endif %}">
                            {% if image.is_deleted %}Deleted{% else %}Active{% endif %}
                        </span>
                    </div>
                    {% if image.file_hash %}
                    <div class="list-group-item">
                        <small class="text-muted">File Integrity Verified</small><br>
                        <code style="font-size: 0.7rem;">{{ image.file_hash }}</code>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-link"></i> Quick Links</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if image.subreddit %}
                    <a href="/?subreddit={{ image.subreddit }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-filter"></i> More from r/{{ image.subreddit }}
                    </a>
                    {% endif %}
                    {% if image.author %}
                    <a href="/?user={{ image.author }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-user"></i> More from u/{{ image.author }}
                    </a>
                    {% endif %}
                    {% if image.permalink %}
                    <a href="https://reddit.com{{ image.permalink }}" target="_blank" class="btn btn-outline-danger btn-sm">
                        <i class="fab fa-reddit"></i> Original Reddit Post
                    </a>
                    {% endif %}
                    <a href="/" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-home"></i> Gallery Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Raw JSON Data (for debugging) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-code"></i> Raw Metadata</h6>
            </div>
            <div class="card-body">
                <pre><code>{{ image | tojson(indent=2) }}</code></pre>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-copy filename on click
document.querySelectorAll('code').forEach(code => {
    code.addEventListener('click', function() {
        const text = this.textContent;
        navigator.clipboard.writeText(text).then(() => {
            // Show a small toast notification
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.innerHTML = '<div class="toast show" role="alert"><div class="toast-body">Copied to clipboard!</div></div>';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        });
    });
    
    code.style.cursor = 'pointer';
    code.title = 'Click to copy';
});

// AJAX for comment submission
document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var commentText = document.getElementById('commentText').value.trim();
    var statusDiv = document.getElementById('commentStatus');
    if (!commentText) {
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-warning';
        statusDiv.textContent = 'Comment cannot be empty.';
        return;
    }
    statusDiv.style.display = 'none';
    fetch('/api/post_comment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            image_id: '{{ image.id }}',
            comment: commentText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new comment to the top of the list
            var commentsList = document.getElementById('commentsList');
            var newComment = document.createElement('li');
            newComment.className = 'list-group-item';
            newComment.innerHTML = `<div class='fw-bold' style='font-size:0.80em;'>${data.comment.author || 'You'}</div>
                <div class='text-muted' style='font-size:0.50em;'>Score: ${data.comment.score || 1} | just now</div>
                <div style='font-size:0.80em;'>${data.comment.body}</div>`;
            if (commentsList) {
                commentsList.prepend(newComment);
            }
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-success';
            statusDiv.textContent = 'Comment posted successfully!';
            document.getElementById('commentText').value = '';
        } else {
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = data.error || 'Failed to post comment.';
        }
    })
    .catch(() => {
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-danger';
        statusDiv.textContent = 'Network error.';
    });
});

// Auto-fetch and update comments on page load
window.addEventListener('DOMContentLoaded', function() {
    var imageId = {{ image.id }};
    var commentsList = document.getElementById('commentsList');
    var commentsCardBody = commentsList ? commentsList.parentElement : null;
    fetch('/api/comments/' + imageId)
        .then(response => response.json())
        .then(data => {
            if (data.success && commentsList && commentsCardBody) {
                if (data.comments.length > 0) {
                    commentsList.innerHTML = '';
                    data.comments.forEach(function(comment) {
                        var li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `<div class='fw-bold' style='font-size:0.80em;'>${comment.author || 'Unknown'}</div>
                            <div class='text-muted' style='font-size:0.50em;'>Score: ${comment.score || 1} | ${comment.created_utc ? new Date(comment.created_utc * 1000).toLocaleString() : ''}</div>
                            <div style='font-size:0.80em;'>${comment.body}</div>`;
                        commentsList.appendChild(li);
                    });
                } else {
                    commentsList.innerHTML = '';
                    var noCommentsDiv = document.createElement('div');
                    noCommentsDiv.className = 'text-muted';
                    noCommentsDiv.textContent = 'No comments found.';
                    commentsCardBody.appendChild(noCommentsDiv);
                }
            }
        });
});
</script>

{% endblock %}